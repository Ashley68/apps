<!DOCTYPE html> 
<html lang="en"> 
<head> 
	<meta charset="utf-8"> 
	<title>Profiles | Python Django Starter Kit</title> 
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="Various tools and reference material to get started and up to speed with Python Django.">
  <meta name="author" content="Steve Carey, TechandStartup.com founder">
	<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />  
	<link rel="stylesheet" type="text/css" href="css/bootstrap-responsive.min.css" />  
	<style type="text/css">
		body {
			padding-top:60px;
		}
		/* The adjust-anchor class is also related to the navbar-fixed-top class. It is needed when you have internal links on the page. Without it the top line of the anchored link would be hidden by the navbar. */
		.adjust-anchor {
			padding-top: 40px; 
			margin-top: -40px;
		}
	</style>
</head>
<body>

	<!-- NAVBAR -->
  <div class="navbar navbar-inverse navbar-fixed-top">  
    <div class="navbar-inner">
			<div class="container">
				<button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="brand" href="#">Python Django Starter Kit</a>
				<div class="nav-collapse collapse">
					<ul class="nav pull-right">
						<li><a href="index.html">Home</a></li>
						<!-- Tools Dropdown Menu  -->
						<li class="dropdown"> 
							<a href="#" class="dropdown-toggle" data-toggle="dropdown">
								Tools
								<b class="caret"></b>
							</a>
							<ul class="dropdown-menu">
                <li><a href="python-tools.html">Django Environment</a></li>
                <li><a href="python-postgres.html">Install PostgreSQL</a></li>
              </ul>
						</li>
						<!-- Reference Dropdown Menu  -->
						<li class="dropdown"> 
							<a href="#" class="dropdown-toggle" data-toggle="dropdown">
								Code Reference
								<b class="caret"></b>
							</a>
							<ul class="dropdown-menu">
                <li><a href="python-command.html">Command Line</a></li>
                <li><a href="#">Django Reference (coming soon)</a></li>
              </ul>
						</li>
						<!-- Django Apps Dropdown Menu  -->
						<li class="dropdown active"> 
							<a href="#" class="dropdown-toggle" data-toggle="dropdown">
								Django Apps
								<b class="caret"></b>
							</a>
							<ul class="dropdown-menu">
								<li><a href='python-pollsapp.html'>Pollsapp</a></li>
								<li><a href='python-simple-site.html'>Simple Site</a></li>
								<li><a href='python-contact.html'>Contact Form</a></li>
                <li><a href='python-admin.html'>Admin Console</a></li>
                <li><a href='python-login.html'>Login</a></li>
                <li><a href='python-registration.html'>Registration</a></li>
                <li><a href='python-pwreset.html'>Password Reset</a></li>
                <li><a href='python-pwchange.html'>Change Password</a></li>
                <li class="active"><a href='python-profiles.html'>Profiles</a></li>
                <li><a href='python-stuff.html'>Stuff App</a></li>
                <li><a href='python-images.html'>Upload Images</a></li>
              </ul>
						</li>
            <li><a href="python-heroku.html">Heroku Hosting</a></li>
					</ul>
				</div><!--/.nav-collapse -->
			</div><!--/.container -->	
    </div><!--/.navbar-inner -->
  </div><!--/.navbar -->
	
	<!-- CONTENT -->
	<div class="container">

        
    <!-- Page Header -->
    <div class="well">  <!-- <div class="page-header">  -->
      <h1>Custom User Profile <small>with Django</small></h1>
      <hr/>

      <p>In this tutorial we will create a customized User Profile. Previous authentication tutorials (Login, Registration, etc.) were based on the standard Django User model which is limited to a username, password, email, first name and last name. If you want to add additional fields, Django 1.5 allows you to create a user model subclass (earlier versions did not have this feature) to either add fields to the standard user profile, or create a custom user profile with new fields. This tutorial will show you how to do both.</p>
      <p>We will assume you already have a Django project started with the initial files set up. You can do that by following the simplesite tutorial to create a simple two page website using the Django framework.</p>
      <p>Prerequisites: This tutorial assumes you are familiar with HTML and CSS; a basic command line interface (e.g., Windows Command Prompt, OSX Terminal, Linux Bash); the basics of the Python Programming Language; and preferrably you have already gone through the Django "Polls App" Tutorial at Djangoproject.org. At a minimum, you should have the following already installed: A text editor, Python version 2.7 and Django.</p>

      There are multiple versions of this tutorial. Click on the tab to see each. It is recommended that you go through them in order.</li>
      <ul>
        <li>Extend the Django User Profile</li>
        <li>Create a Custom User Profile</li>
        <li>Custom User Profile with Login and Registration Forms</li>
      </ul>

    </div>

    <!-- TABS TO SELECT ENVIRONMENT -->
    <ul class="nav nav-tabs">
      <li class="active"><a href="#extend" data-toggle="tab">Extend Profile</a></li>
      <li><a href="#custom" data-toggle="tab">Custom Profile</a></li>
      <li><a href="#loginreg" data-toggle="tab">Login/Reg Forms</a></li>
    </ul>
        
    <div id="myTabContent" class="tab-content">


      <!-------------------------------------------------------------------------------------------------------- 
      -----------  EXTENDED PROFILE  ------------------------------------------------------------------------------>
      <div class="tab-pane fade in active" id="extend">
        <div class='row-fluid'>
          <div class='span9 container-fluid'>

            <h2>Extend the Standard User Profile</h2>
            
            <!-- Overview -->
            <h3 id="extend-overview" class="adjust-anchor">Overview</h3>
            <ul>
              <li>Extending the default Django user model means we will continue to use the username, password, email, first_name and last_name fields in the user's profile, but want to add more fields.</li>
              <li>We need to create a profile app, and in it populate the models.py and admin.py files.</li>
              <li>Django's user model is part of the built-in Auth module. The various model classes are located in (from your Python or Virtualenvs folder) lib/site-packages/django/contrib/auth/models.py</li>
              <li>We will be creating a subclass of the existing user model so we don't have to recreate the existing code.</li>
            </ul>
            
            <!-- Set Up the Project -->
            <h3 id="extend-setup" class="adjust-anchor">Setup</h3>
            <ul>
              <li>Create a separate user profile app within your project folder.</li>
              <ul>
                <li>Open your command line interface (e.g., Terminal for Mac, Command Prompt for Windows, Bash for Linux).</li>
                <li>Change Directories to your site's upper directory <code>cd /localsites/simplesite</code> or whatever the path is to the manage.py file.</li>
                <li>Create the folder and files for the application that we'll call profiles. In the command line enter <code>python manage.py startapp profiles</code></li>
              </ul>
              <li>Open the settings.py file in your site's main directory. In one of the rows under <code>INSTALLED_APPS = (</code> enter <code>'profiles',</code>. Now Django will know to include this app with your site.</li>
              <li>At the bottom of the settings.py file add <code>AUTH_USER_MODEL = 'profiles.ExpandedUser' </code>. This will tell Django to substitute the ExpandedUser model for the standard User model.</li>
            </ul>              
            
            <!-- MODELS -->
            <h3 id="extend-models" class="adjust-anchor">Models</h3>
            <ul>
              <li>In the profiles folder, open the models.py file and insert the following:
<pre>
from django.contrib.auth.models import AbstractUser
from django.db import models
from django.utils.translation import ugettext_lazy as _


class ExpandedUser(AbstractUser):
    city = models.CharField(_("city"), max_length=20, blank=True)
    state = models.CharField(_("state"), max_length=20, blank=True)
    zip = models.CharField(_("zip code"), max_length=5, blank=True)
</pre>
              </li>
              <li>The ExpandedUser class (you can name it whatever you want) is a subclass of the AbstractUser class. You can see the details of the AbstractUser class in the Django Auth module located in (from your Python or Virtualenvs folder) lib/site-packages/django/contrib/auth/models.py. By inheriting from the AbstractUser class, you keep all the default user fields (username, email, first_name, last_name) and you can add whatever fields you want. In this case we add city, state and zip code.</li>
              <li>We imported <code>ugettext_lazy as _</code> which enables us to use different field names for the database and the user display. For example the user display will show a field name of <i>zip code</i> but the database field name is <i>zip</i></li>
            </ul>
            
            <!-- Admin -->
            <h3 id="extend-admin" class="adjust-anchor">Manage Profiles Using the Admin Console</h3>
            <ul>
              <li>As the site administrator, you can use the Admin Console to view, add, modify, or delete users.</li>
              <li>Activate Django's Admin App.</li>
              <ul>
                <li>Open the settings.py file. Under <code>INSTALLED_APPS</code> uncomment the Admin App line <code>'django.contrib.admin',</code>.</li>
                <li>Now sync the database to create the database tables for the Admin app. Open the command line interface and change directories to the upper directory of your site (where manage.py is). Type <code>python manage.py syncdb</code>.</li>
                <li>Edit the simplesite/urls.py file (in the same directory as settings.py) and uncomment the three lines that reference admin so it looks like the below (excluding other links or code you may have).
<pre>
from django.conf.urls import patterns, include, url

from django.contrib import admin
admin.autodiscover()

urlpatterns = patterns('',
    url(r'^admin/', include(admin.site.urls)),
)
</pre>
                </li>
              </ul>
              <li>The admin console is now activated. Let's now add the ability to manage users through the Admin Console. Create a file named admin.py, save it to the profiles folder, and populate it with one of the the following. First without modifying the Admin display:
<pre>
from django.contrib import admin
from profiles.models import ExpandedUser

admin.site.register(ExpandedUser)
</pre>              
              </li>
              <li>You can jump to the next section to test it.</li>
              <li>The second option does a lot to organize how it appears in the Admin Console. Replace the admin.py file content with the following:
<pre>
from django.contrib import admin
from profiles.models import ExpandedUser


class ExpandedUserAdmin(admin.ModelAdmin):
    fieldsets = [
        ('User Info', {'fields': ['username', 'first_name', 'last_name', 'email',
                                  'password', 'city', 'state', 'zip']}),
        ('Date information', {'fields': ['date_joined', 'last_login'], 'classes': ['collapse']}),
        ('Permissions', {'fields': ['is_active', 'is_staff', 'is_superuser']}),
    ]

    list_filter = ['city']

    list_display = ['username', 'first_name', 'last_name', 'email', 'city', 'state',
                    'date_joined', 'last_login']

admin.site.register(ExpandedUser, ExpandedUserAdmin)
</pre>              
              </li>
              <li>In this version we added a class called ExpandedUserAdmin. It groups the fields into three fieldsets on the user creation form and the user change form. The Date information fieldset has an added collapse class. You can delete the added class if you don't want it collapsed.</li>
              <li>When viewing the list of users we added <code>list_filter</code> to have the option of filtering by city.</li>
              <li>We added <code>list_display</code> to show specific fields when viewing the list of users.</li>
              <li>We register both the ExpandedUser and the ExpandedUserAdmin class.</li>
            </ul>
             
            <!-- TESTING -->
            <h3 id="extend-testing" class="adjust-anchor">Testing</h3>
            <ul>
              <!--li>Syncronize the database settings with the actual database. Open the command line interface. From the upper site directory (the folder with the manage.py file in it) enter <code>python manage.py syncdb</code></li-->
              <li>Run the virtual server and test that the new profiles app is working in the Admin Console.</li>
              <ul>
                <li>from the upper site directory enter <code>python manage.py runserver</code></li>
                <li>Go to the browser and put in your local ip address, port 8000, and /admin/ as the url: <a href="http://127.0.0.1:8000/admin/" target="_blank">http://127.0.0.1:8000/admin</a></li>
                <li>Click on "profiles". It should take you to the Profiles Administration Page.</li>
                <li>Click on Users, you should see yourself and the list of fields we put in the list_display.</li>
                <li>Click on a user and you should see the fieldsets as we entered them under fieldsets. You can edit your info. Add a new user. Delete a user. If it works, you're done.</li>
              </ul>
            </ul>
              
          </div> <!--/.span9 -->  
          
          <!-- SIDEBAR -->
          <div class='span3'>
            <ul class="nav nav-tabs nav-stacked">
              <li><a href='#extend-overview'><i class="icon-chevron-left"></i> Overview</a></li>		
              <li><a href='#extend-setup'><i class="icon-chevron-left"></i> Set Up the Project</a></li>					
              <li><a href='#extend-models'><i class="icon-chevron-left"></i> Models</a></li>	 
              <li><a href='#extend-admin'><i class="icon-chevron-left"></i> Admin</a></li>
              <li><a href='#extend-testing'><i class="icon-chevron-left"></i> Testing</a></li>              
            </ul>
          </div> <!--/.span3 -->
        </div> <!-- /.row -->
      </div><!--/#V3- -->
      
      
      <!-------------------------------------------------------------------------------------------------------- 
      -----------  CUSTOM PROFILE  ------------------------------------------------------------------------------>
      <div class="tab-pane fade" id="custom">
        <div class='row-fluid'>
          <div class='span9 container-fluid'>

            <h2>Create a Custom User Profile</h2>
            
            <!-- Overview -->
            <h3 id="custom-overview" class="adjust-anchor">Overview</h3>
            <ul>
              <li>Django's user model is part of the built-in Auth module. The various model classes are located in (from your Python or Virtualenvs folder) lib/site-packages/django/contrib/auth/models.py</li>
              <li>The default Django user profile fields are username, password, email, first_name and last_name, with username and password required for login. If you don't want to use all these fields or if you want users to login with their email address rather then username then you need to create a custom user profile.</li>
              <li>As with extending the default user profile, you create a subclass of the existing user model so you don't have to recreate all the existing code. Django has two user model classes. We created a subclass of the AbstractUser class when we extended the user profile. Django also has a stripped down class called AbstractBaseUser that includes only the Password field, last login date, and is_active=True. You can create whatever fields you like.</li>
              <li>Our custom user profile will use email as the username and require a password and city. It will not include first_name or last_name.</li>
              <li>To create a custom user profile we need to create an app (we'll call it profile), and in it populate the models.py and admin.py files.</li>
            </ul>
            
            <!-- Set Up the Project -->
            <h3 id="custom-setup" class="adjust-anchor">Setup</h3>
            <ul>
              <li>Create a separate user profile app within your project folder.</li>
              <ul>
                <li>Open your command line interface (e.g., Terminal for Mac, Command Prompt for Windows, Bash for Linux).</li>
                <li>Change Directories to your site's upper directory <code>cd /localsites/simplesite</code> or whatever the path is to the manage.py file.</li>
                <li>Create the folder and files for the application that we'll call profiles (you can call it whatever you like). In the command line enter <code>python manage.py startapp profiles</code></li>
              </ul>
              <li>Open the settings.py file in your site's main directory. In one of the rows under <code>INSTALLED_APPS = (</code> enter <code>'profiles',</code>. Now Django will know to include this app with your site.</li>
              <li>At the bottom of the settings.py file add <code>AUTH_USER_MODEL = 'profiles.CustomUser' </code>. This will tell Django to substitute the CustomUser model for the standard User model.</li>
            </ul>              
            
            <!-- MODELS -->
            <h3 id="custom-models" class="adjust-anchor">Models</h3>
            <ul>
              <li>In the profiles folder, open the models.py file and insert the following:
<pre>
from django.db import models
from django.contrib.auth.models import (BaseUserManager, AbstractBaseUser, PermissionsMixin)


class CustomUserManager(BaseUserManager):
    def create_user(self, email, city, password=None):
        """ Creates and saves a User with the given email, city, and password. """
        if not email:
            msg = "Please enter an email address"
            raise ValueError(msg)

        if not city:
            msg = "Please enter your city"
            raise ValueError(msg)

        user = self.model(
            email=CustomUserManager.normalize_email(email),
            city=city,
        )

        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, email, city, password):
        """ Creates and saves a superuser with the given email, city and password. """
        user = self.create_user( email, password=password, city=city)
        user.is_admin = True
        user.is_staff = True
        user.is_superuser = True
        user.save(using=self._db)
        return user

USERNAME_FIELD = "email"
REQUIRED_FIELDS = ["city", ]


class CustomUser(AbstractBaseUser, PermissionsMixin):
    # Inherits from both the AbstractBaseUser and PermissionMixin.
    email = models.EmailField(verbose_name ="email address", max_length=255, unique=True, db_index=True,)
    city = models.CharField(max_length=255)
    is_active = models.BooleanField(default=True)
    is_admin = models.BooleanField(default=False)
    is_staff = models.BooleanField(default=False)

    objects = CustomUserManager()

    USERNAME_FIELD = USERNAME_FIELD
    REQUIRED_FIELDS = REQUIRED_FIELDS

    def get_full_name(self):
        # The user is identified by their email and city
        return self.email, self.city

    def get_short_name(self):
        # The user is identified by their email address
        return self.email

    def __unicode__(self):
        return self.email
</pre>
              </li>
              <li>The CustomUserManager class (you can name it whatever you want) is for creating new users and superusers. It is a subclass of the BaseUserManager class, part of the Django Auth module. You can see the details of the class in the Django Auth module located in (from your Python or Virtualenvs folder) lib/site-packages/django/contrib/auth/models.py. </li>
              <li>The <code>USERNAME_FIELD</code> constant is where you define the unique identifier. The default is username, but here we assigned it to the email field. This field must be set to unique=True, and db_index=True.</li>
              <li>The <code>REQUIRED_FIELDS</code> constant is where you set the required fields. The USERNAME_FIELD, email, is excluded because it is automatically required.</li>
              <li>The CustomUser class (you can name it whatever you want) is a subclass of the AbstractBaseUser class. By inheriting from the AbstractBaseUser class, you keep a stripped down version of the Django default user model including the password field, last login date, and is_active=True.</li>
              <li></li>
            </ul>
            
            <!-- Admin -->
            <h3 id="custom-admin" class="adjust-anchor">Manage Profiles Using the Admin Console</h3>
            <ul>
              <li>As the site administrator, you can use the Admin Console to view, add, modify, or delete users.</li>
              <li>Activate Django's Admin App.</li>
              <ul>
                <li>Open the settings.py file. Under <code>INSTALLED_APPS</code> uncomment the Admin App line <code>'django.contrib.admin',</code>.</li>
                <li>Now sync the database to create the database tables for the Admin app. Open the command line interface and change directories to the upper directory of your site (where manage.py is). Type <code>python manage.py syncdb</code>.</li>
                <li>Edit the simplesite/urls.py file (in the same directory as settings.py) and uncomment the three lines that reference admin so it looks like the below (excluding other links or code you may have).
<pre>
from django.conf.urls import patterns, include, url

from django.contrib import admin
admin.autodiscover()

urlpatterns = patterns('',
    url(r'^admin/', include(admin.site.urls)),
)
</pre>
                </li>
              </ul>
              <li>The admin console is now activated. Let's now add the ability to manage users through the Admin Console. Create a file named admin.py, save it to the profiles folder, and populate it with the following:
<pre>
from django import forms
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from django.contrib.auth.forms import ReadOnlyPasswordHashField
from profiles.models import CustomUser


class CustomUserCreationForm(forms.ModelForm):
    # A form for creating new users. Includes all the required fields, plus a repeated password.
    password1 = forms.CharField(label="Password", widget=forms.PasswordInput)
    password2 = forms.CharField(label="Password confirmation", widget=forms.PasswordInput)

    class Meta:
        model = CustomUser
        fields = ("email", "city")

    def clean_password2(self):
        # Check that the two password entries match
        data = self.cleaned_data
        password1 = data.get("password1")
        password2 = data.get("password2")
        if password1 and password2 and password1 != password2:
            msg = "Passwords do not match"
            raise forms.ValidationError(msg)
        return password2

    def save(self, commit=True):
        # Save the provided password in hashed format
        user = super(CustomUserCreationForm, self).save(commit=False)
        data = self.cleaned_data
        user.set_password(data["password1"])
        if commit:
            user.save()
        return user

class CustomUserChangeForm(forms.ModelForm):
    # A form for updating users. Includes all the fields on the user, but replaces the password field
    # with admin's password hash display field.
    password = ReadOnlyPasswordHashField()

    class Meta:
        model = CustomUser

    def clean_password(self):
        # Regardless of what the user provides, return the initial value. This is done here,
        # rather than on the field, because the field does not have access to the initial value.
        return self.initial["password"]


class CustomUserAdmin(UserAdmin):
    # Forms to add and change user instances
    form = CustomUserChangeForm
    add_form = CustomUserCreationForm

    # The fields to be used in displaying the User model. These override the definitions on the
    # base UserAdmin that reference specific fields on auth.User.
    list_display = ("email", "city", "is_staff")
    list_filter = ("is_staff", "is_superuser", "is_active", "groups")
    search_fields = ("email", "city")
    ordering = ("email",)
    filter_horizontal = ("groups", "user_permissions",)
    fieldsets = (
        (None, {"fields": ("email", "password")}),
        ("Personal info", {"fields": ("city",)}),
        ("Permissions", {"fields": ("is_active", "is_staff", "is_superuser", "groups", "user_permissions")}),
        ("Important dates", {"fields": ("last_login",)}),
    )

    add_fieldsets = (
        (None, {
            "classes": ("wide",),
            "fields": ("email", "city", "password1", "password2")}
        ),
    )

# Register the new Customuser and CustomUserAdmin classes
admin.site.register(CustomUser, CustomUserAdmin)
</pre>              
              </li>
              <li>The CustomUserCreationForm class is used to specify the fields for creating a new user.</li>
              <li>The CustomUserChangeForm converts the raw password to a hashed password.</li>
              <li>The CustomUserAdmin class sets up the Admin console for the custom user profile. Enter the fields and how you want them displayed.</li>
              <li>We register both the CustomUser and the CustomUserAdmin class.</li>
            </ul>
             
            <!-- TESTING -->
            <h3 id="custom-testing" class="adjust-anchor">Testing</h3>
            <ul>
              <li>Syncronize the database settings with the actual database. Open the command line interface. From the upper site directory (the folder with the manage.py file in it) enter <code>python manage.py syncdb</code></li>
              <li>Run the virtual server and test that the new profiles app is working in the Admin Console.</li>
              <ul>
                <li>from the upper site directory enter <code>python manage.py runserver</code></li>
                <li>Go to the browser and put in your local ip address, port 8000, and /admin/ as the url: <a href="http://127.0.0.1:8000/admin/" target="_blank">http://127.0.0.1:8000/admin</a></li>
                <li>Click on "profiles". It should take you to the Profiles Administration Page.</li>
                <li>Click on Users, you should see yourself and the list of fields we put in the list_display.</li>
                <li>Click on a user and you should see the fieldsets as we entered them under fieldsets. You can edit your info. Add a new user. Delete a user. If it works, you're done.</li>
              </ul>
            </ul>
              
          </div> <!--/.span9 -->  
          
          <!-- SIDEBAR -->
          <div class='span3'>
            <ul class="nav nav-tabs nav-stacked">
              <li><a href='#custom-overview'><i class="icon-chevron-left"></i> Overview</a></li>		
              <li><a href='#custom-setup'><i class="icon-chevron-left"></i> Set Up the Project</a></li>					
              <li><a href='#custom-models'><i class="icon-chevron-left"></i> Models</a></li>	 
              <li><a href='#custom-admin'><i class="icon-chevron-left"></i> Admin</a></li>
              <li><a href='#custom-testing'><i class="icon-chevron-left"></i> Testing</a></li>              
            </ul>
          </div> <!--/.span3 -->
        </div> <!-- /.row -->
      </div><!--/#V3- -->      
      
      
      <!-------------------------------------------------------------------------------------------------------- 
      -----------  CUSTOM PROFILE WITH LOGIN AND REGISTRATION  ------------------------------------------------>
      <div class="tab-pane fade" id="loginreg">
        <div class='row-fluid'>
          <div class='span9 container-fluid'>

            <h2>Custom Profile with Login and Registration</h2>
            
            <!-- Overview -->
            <h3 id="loginreg-overview" class="adjust-anchor">Overview</h3>
            <ul>
              <li>This tutorial is the same as the Custom User Profile tutorial except it adds user login and registration forms, views and templates.</li>
              <li>Django's user model is part of the built-in Auth module. The various model classes are located in (from your Python or Virtualenvs folder) lib/site-packages/django/contrib/auth/models.py</li>
              <li>The default Django user profile fields are username, password, email, first_name and last_name, with username and password required for login. If you don't want to use all these fields or if you want users to login with their email address rather then username then you need to create a custom user profile.</li>
              <li>As with extending the default user profile, you create a subclass of the existing user model so you don't have to recreate all the existing code. Django has two user model classes. We created a subclass of the AbstractUser class when we extended the user profile. Django also has a stripped down class called AbstractBaseUser that includes only the Password field, last login date, and is_active=True. You can create whatever fields you like.</li>
              <li>Our custom user profile will use email as the username and require a password and city. It will not include first_name or last_name.</li>
              <li>To create a custom user profile we need to create an app (we'll call it profile), and in it populate the models.py and admin.py files.</li>
            </ul>
            
            <!-- Set Up the Project -->
            <h3 id="loginreg-setup" class="adjust-anchor">Setup</h3>
            <ul>
              <li>Create a separate user profile app within your project folder.</li>
              <ul>
                <li>Open your command line interface (e.g., Terminal for Mac, Command Prompt for Windows, Bash for Linux).</li>
                <li>Change Directories to your site's upper directory <code>cd /localsites/simplesite</code> or whatever the path is to the manage.py file.</li>
                <li>Create the folder and files for the application that we'll call profiles (you can call it whatever you like). In the command line enter <code>python manage.py startapp profiles</code></li>
              </ul>
              <li>Open the settings.py file in your site's main directory. In one of the rows under <code>INSTALLED_APPS = (</code> enter <code>'profiles',</code>. Now Django will know to include this app with your site.</li>
              <li>At the bottom of the settings.py file add <code>AUTH_USER_MODEL = 'profiles.CustomUser' </code>. This will tell Django to substitute the CustomUser model for the standard User model.</li>
            </ul>              
            
            <!-- MODELS -->
            <h3 id="loginreg-models" class="adjust-anchor">Models</h3>
            <ul>
              <li>In the profiles folder, open the models.py file and insert the following:
<pre>
from django.db import models
from django.contrib.auth.models import (BaseUserManager, AbstractBaseUser, PermissionsMixin)


class CustomUserManager(BaseUserManager):
    def create_user(self, email, city, password=None):
        """ Creates and saves a User with the given email, city, and password. """
        if not email:
            msg = "Please enter an email address"
            raise ValueError(msg)

        if not city:
            msg = "Please enter your city"
            raise ValueError(msg)

        user = self.model(
            email=CustomUserManager.normalize_email(email),
            city=city,
        )

        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, email, city, password):
        """ Creates and saves a superuser with the given email, city and password. """
        user = self.create_user( email, password=password, city=city)
        user.is_admin = True
        user.is_staff = True
        user.is_superuser = True
        user.save(using=self._db)
        return user

USERNAME_FIELD = "email"
REQUIRED_FIELDS = ["city", ]


class CustomUser(AbstractBaseUser, PermissionsMixin):
    # Inherits from both the AbstractBaseUser and PermissionMixin.
    email = models.EmailField(verbose_name ="email address", max_length=255, unique=True, db_index=True,)
    city = models.CharField(max_length=255)
    is_active = models.BooleanField(default=True)
    is_admin = models.BooleanField(default=False)
    is_staff = models.BooleanField(default=False)

    objects = CustomUserManager()

    USERNAME_FIELD = USERNAME_FIELD
    REQUIRED_FIELDS = REQUIRED_FIELDS

    def get_full_name(self):
        # The user is identified by their email and city
        return self.email, self.city

    def get_short_name(self):
        # The user is identified by their email address
        return self.email

    def __unicode__(self):
        return self.email
</pre>
              </li>
              <li>The CustomUserManager class (you can name it whatever you want) is for creating new users and superusers. It is a subclass of the BaseUserManager class, part of the Django Auth module. You can see the details of the class in the Django Auth module located in (from your Python or Virtualenvs folder) lib/site-packages/django/contrib/auth/models.py. </li>
              <li>The <code>USERNAME_FIELD</code> constant is where you define the unique identifier. The default is username, but here we assigned it to the email field. This field must be set to unique=True, and db_index=True.</li>
              <li>The <code>REQUIRED_FIELDS</code> constant is where you set the required fields. The USERNAME_FIELD, email, is excluded because it is automatically required.</li>
              <li>The CustomUser class (you can name it whatever you want) is a subclass of the AbstractBaseUser class. By inheriting from the AbstractBaseUser class, you keep a stripped down version of the Django default user model including the password field, last login date, and is_active=True.</li>
            </ul>

            <!-- FORMS -->
            <h3 id="loginreg-forms" class="adjust-anchor">Forms</h3>
            <ul>
              <li>Create a file named forms.py, save it in the profiles folder, and populate it with the following:
<pre>
from django import forms
from django.contrib.auth.forms import ReadOnlyPasswordHashField
from profiles.models import CustomUser


class CustomUserCreationForm(forms.ModelForm):
    # A form for creating new users. Includes all the required fields, plus a repeated password.
    password1 = forms.CharField(label="Password", widget=forms.PasswordInput)
    password2 = forms.CharField(label="Password confirmation", widget=forms.PasswordInput)

    class Meta:
        model = CustomUser
        fields = ("email", "city")

    def clean_password2(self):
        # Check that the two password entries match
        data = self.cleaned_data
        password1 = data.get("password1")
        password2 = data.get("password2")
        if password1 and password2 and password1 != password2:
            msg = "Passwords do not match"
            raise forms.ValidationError(msg)
        return password2

    def save(self, commit=True):
        # Save the provided password in hashed format
        user = super(CustomUserCreationForm, self).save(commit=False)
        data = self.cleaned_data
        user.set_password(data["password1"])
        if commit:
            user.save()
        return user


class CustomUserChangeForm(forms.ModelForm):
    # A form for updating users. Includes all the fields on the user, but replaces the password field
    # with admin's password hash display field.
    password = ReadOnlyPasswordHashField()

    class Meta:
        model = CustomUser

    def clean_password(self):
        # Regardless of what the user provides, return the initial value. This is done here,
        # rather than on the field, because the field does not have access to the initial value.
        return self.initial["password"]
</pre>
              </li>
              <li>We moved the CustomUserCreationForm and CustomUserChangeForm from the admin.py file so it can be used both in the Admin console and by site users in the registration form.</li>
            </ul>   
            
            <!-- Urls -->
            <h3 id="loginreg-urls" class="adjust-anchor">URLs</h3>
            <ul>
              <li>Now we will dispatch the URLs.</li>
              <li>Go to the lower simplesite folder (where settings.py is) and open the urls.py file. Below <code>urlpatterns = patterns('',</code> insert <code>    (r'^accounts/', include('profiles.urls')), </code>. This links the profiles urls to the main url dispatch file.</li>
              <li>Create a file called urls.py, save it to the profiles directory, and populate it with the following:
<pre>
from django.conf.urls import patterns, url


urlpatterns = patterns('',
    # login URLs:
    url(r'^login/$', 'django.contrib.auth.views.login', name='login'),
    url(r'^logout/$', 'django.contrib.auth.views.logout', name='logout'),
    url(r'^loggedin/$', 'profiles.views.loggedin', name='loggedin'),
    # Registration URLs
    url(r'^register/$', 'profiles.views.register', name='register'),
    url(r'^register/complete/$', 'profiles.views.registration_complete', name='registration_complete'),
)  
</pre>
              </li>
              <li>Open the settings.py file and at the bottom insert <code>LOGIN_REDIRECT_URL = '/accounts/loggedin/'</code>. Django's default is to redirect to <code>/accounts/profile</code> when you log in, which is fine if you have an profile page at that url. If not you need to change your settings default for the Login redirect url to the one holding your loggedin.html page.</li>
            </ul>             
            
            <!-- Views -->
            <h3 id="loginreg-views" class="adjust-anchor">Views</h3>
            <ul>
              <li>Create a file called views.py, save it to the profiles folder and populate it with the following:
<pre>
from django.shortcuts import render_to_response
from django.http import HttpResponseRedirect
from profiles.forms import CustomUserCreationForm
from django.core.context_processors import csrf


def loggedin(request):
    return render_to_response('registration/loggedin.html',
                              {'email': request.user.email})


def register(request):
    if request.method == 'POST':
        form = CustomUserCreationForm(request.POST)
        if form.is_valid():
            form.save()
            return HttpResponseRedirect('/accounts/register/complete')

    else:
        form = CustomUserCreationForm()
    token = {}
    token.update(csrf(request))
    token['form'] = form

    return render_to_response('registration/registration_form.html', token)


def registration_complete(request):
    return render_to_response('registration/registration_complete.html')
</pre>
              </li>
              <li>You don't need to create functions rendering the login and logout pages because these are done through the Django Auth module.</li>
              <li>We added a variable called email in the loggedin function to be passed to the loggedin.html template.</li>
            </ul>             
       
            <!-- Templates -->
            <h3 id="loginreg-templates" class="adjust-anchor">Templates</h3>
            <ul>
              <li>We will assume your site already has a templates directory and a base.html file with a navigation bar. Open the base.html file and in the nav element add the following navigation menu links:
<pre>
&lt;a href="/accounts/register">Register&lt;/a>
&lt;a href="/accounts/login">Login&lt;/a>
&lt;a href="/accounts/logout">Logout&lt;/a>
&lt;a href="/admin">Admin&lt;/a>
</pre>              
              </li>
              <li>Create a directory called registration inside the templates folder. If you do this through the command line, type <code>mkdir registration</code></li>
              <li>Start with the login templates. Create a file called login.html, save it to the templates/registration folder, and populate it with the following:
<pre>
{% extends "base.html" %}
{% block title %}Log In{% endblock %}
{% block content %}

&lt;form method="post" action="{% url 'django.contrib.auth.views.login' %}">
{% csrf_token %}
&lt;table>
  {{ form.as_table }}
&lt;/table>

&lt;input type="submit" value="login" />
&lt;/form>

{% endblock %}
</pre>
              </li>
              <li><code>{{ form.as_table }}</code> uses the Django Forms module to create the form. You can create an unformatted form by using <code>{{ form }}</code> without the HTML table tags, or have each field put inside paragraph tags with <code>{{ form.as_p }}</code>, or as an unordered list <code>{{ form.as_ul }}</code></li>
              <li>Create a file called loggedin.html, save it to the templates/registration folder, and populate it with the following:
<pre>
{% extends "base.html" %}
{% block title %}Logged In{% endblock %}
{% block content %}

&lt;h1>Welcome {{email}}&lt;/h1>
&lt;p>Thank you for logging in.&lt;/p>
&lt;p>&lt;a href="/accounts/logout/">Logout&lt;/a>&lt;/p>

{% endblock %}
</pre>              
              </li>
              <li>Create a file called logged_out.html, save it to the templates/registration folder and populate it with the following:
<pre>
{% extends "base.html" %}
{% block title %}Logged Out{% endblock %}
{% block content %}

  &lt;h2>Logged out!&lt;/h2>
  &lt;p>&lt;a href="/accounts/login/">Log back in&lt;/a>&lt;/p>

{% endblock %}
</pre>
              </li>
              <li>Now on to the registration templates. Create a file called registration_form.html, save it to the templates/registration folder, and populate it with the following:
<pre>
{% extends "base.html" %}
{% block title %}Register{% endblock %}
{% block content %}

  &lt;h2>Registration&lt;/h2>

  &lt;form action="/accounts/register/" method="post">{% csrf_token %}
    {{form.as_p}}
  &lt;input type="submit" value="Register" />

  &lt;/form>

{% endblock %}
</pre>
              </li>
              <li>Create a file called registration_complete.html, save it to the templates/registration folder, and populate it with the following:
<pre>
{% extends "base.html" %}
{% block title %}You are Registered{% endblock %}
{% block content %}

  &lt;h2>Thank you for Registering&lt;/h2>
  &lt;p>&lt;a href="/accounts/login/">Please Login&lt;/a>&lt;/p>

{% endblock %}
</pre>
              </li>              
            </ul>
       
            <!-- Admin -->
            <h3 id="loginreg-admin" class="adjust-anchor">Manage Profiles Using the Admin Console</h3>
            <ul>
              <li>As the site administrator, you can use the Admin Console to view, add, modify, or delete users.</li>
              <li>Activate Django's Admin App.</li>
              <ul>
                <li>Open the settings.py file. Under <code>INSTALLED_APPS</code> uncomment the Admin App line <code>'django.contrib.admin',</code>.</li>
                <li>Now sync the database to create the database tables for the Admin app. Open the command line interface and change directories to the upper directory of your site (where manage.py is). Type <code>python manage.py syncdb</code>.</li>
                <li>Edit the simplesite/urls.py file (in the same directory as settings.py) and uncomment the three lines that reference admin so it looks like the below (excluding other links or code you may have).
<pre>
from django.conf.urls import patterns, include, url

from django.contrib import admin
admin.autodiscover()

urlpatterns = patterns('',
    url(r'^admin/', include(admin.site.urls)),
)
</pre>
                </li>
              </ul>
              <li>The admin console is now activated. Let's now add the ability to manage users through the Admin Console. Create a file named admin.py, save it to the profiles folder, and populate it with the following:
<pre>
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from profiles.models import CustomUser
from profiles.forms import CustomUserCreationForm, CustomUserChangeForm


class CustomUserAdmin(UserAdmin):
    # Forms to add and change user instances
    form = CustomUserChangeForm
    add_form = CustomUserCreationForm

    # The fields to be used in displaying the User model. These override the definitions on the
    # base UserAdmin that reference specific fields on auth.User.
    list_display = ("email", "city", "is_staff")
    list_filter = ("is_staff", "is_superuser", "is_active", "groups")
    search_fields = ("email", "city")
    ordering = ("email",)
    filter_horizontal = ("groups", "user_permissions",)
    fieldsets = (
        (None, {"fields": ("email", "password")}),
        ("Personal info", {"fields": ("city",)}),
        ("Permissions", {"fields": ("is_active", "is_staff", "is_superuser", "groups", "user_permissions")}),
        ("Important dates", {"fields": ("last_login",)}),
    )

    add_fieldsets = (
        (None, {
            "classes": ("wide",),
            "fields": ("email", "city", "password1", "password2")}
        ),
    )

# Register the new Customuser and CustomUserAdmin classes
admin.site.register(CustomUser, CustomUserAdmin)
</pre>              
              </li>
              <li>The CustomUserAdmin class sets up the Admin console for the custom user profile. Enter the fields and how you want them displayed.</li>
              <li>We register both the CustomUser and the CustomUserAdmin class.</li>
            </ul>
             
            <!-- TESTING -->
            <h3 id="loginreg-testing" class="adjust-anchor">Testing</h3>
            <ul>
              <li>Run the virtual server:</li>
              <ul>
                <li>from the upper site directory enter <code>python manage.py runserver</code></li>
                <li>Go to the browser and put in your local ip address, port 8000, and /admin/ as the url: <a href="http://127.0.0.1:8000/admin/" target="_blank">http://127.0.0.1:8000/admin</a></li>
              </ul>
              <li>Test the Login Process</li>
              <ul>
                <li>Click on the navigation bar's "login" link. It should take you to the login page.</li>
                <li>Fill out the form both incorrectly, to see the error messages, and correctly.</li>
                <li>When filled out correctly you should be directed to the loggedin page.</li>
                <li>Click Logout.</li>
              </ul>
              <li>Test the Registration Process</li>
              <ul>
                <li>Click on the navigation bar's "register" link. It should take you to the registration page.</li>
                <li>Fill out the form both incorrectly, to see the error messages, and correctly.</li>
                <li>When filled out correctly you should be directed to the register_done page.</li>
              </ul>
              <li>Test the Admin Console</li>
              <ul>
                <li>Click on the navigation bar's "admin" link. It should prompt you for your email and password, then take you to the Admin Console.</li>
                <li>Click on Users, you should see yourself and the list of fields we put in the list_display.</li>
                <li>Click on a user and you should see the fieldsets as we entered them under fieldsets. You can edit your info. Add a new user. Delete a user. If it all works, you're done.</li>
              </ul>
            </ul>
              
          </div> <!--/.span9 -->  
          
          <!-- SIDEBAR -->
          <div class='span3'>
            <ul class="nav nav-tabs nav-stacked">
              <li><a href='#loginreg-overview'><i class="icon-chevron-left"></i> Overview</a></li>		
              <li><a href='#loginreg-setup'><i class="icon-chevron-left"></i> Set Up the Project</a></li>					
              <li><a href='#loginreg-models'><i class="icon-chevron-left"></i> Models</a></li>	 
              <li><a href='#loginreg-forms'><i class="icon-chevron-left"></i> Forms</a></li>	 
              <li><a href='#loginreg-urls'><i class="icon-chevron-left"></i> Urls</a></li>	 
              <li><a href='#loginreg-views'><i class="icon-chevron-left"></i> Views</a></li>	 
              <li><a href='#loginreg-templates'><i class="icon-chevron-left"></i> Templates</a></li>	 
              <li><a href='#loginreg-admin'><i class="icon-chevron-left"></i> Admin</a></li>
              <li><a href='#loginreg-testing'><i class="icon-chevron-left"></i> Testing</a></li>              
            </ul>
          </div> <!--/.span3 -->
        </div> <!-- /.row -->
      </div><!--/#loginreg -->      
          
          
      
      <div class="span9">
      
    </div><!--/#myTabContent -->
    
		<hr/>
		<footer class="span9">
			<center>Python Django Starter Kit  |  Posted by <a href="http://techandstartup.com">TechandStartup.com</a></center>
		</footer>

</div>  <!-- /container -->

<!-- Javascript is at the end for faster page loading -->
  <script src="js/jquery-1.10.1.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <!-- Or link to the js files hosted on a content delivery network
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>	-->
</body>
</html> 
            